#!/usr/bin/env bash
# This shell script contains usage of sudo/doas, assuming that
# you configured sudo access for caddy user correctly per
# config/sudo_caddy.conf file.
set -xe

CADDY_CONFIG_HOME=${CADDY_CONFIG_HOME:-"/var/caddy/src"}
FF_USE_DOCKER=${FF_USE_DOCKER:-"0"}
FF_ONLY_RELOAD_CONFIG=${FF_ONLY_RELOAD_CONFIG}
SUDO=${SUDO:-"sudo"}

[ ${FF_FORCE_GIT_PULL+x} ] && git -C $CADDY_CONFIG_HOME pull --ff-only

if [[ ${FF_USE_DOCKER} == "1" ]]; then
  caddy_container_id=$(docker ps | grep caddy | awk '{print $1;}')
  docker exec -w /etc/caddy $caddy_container_id caddy reload
else
  caddy reload --config "${CADDY_CONFIG_HOME}/config/caddy/meta.Caddyfile" --adapter caddyfile
fi
