name: Deployments
on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  proxypartylab-prod-railwayapp:
    name: Production Caddy server on railway.app
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://proxypartylab.up.railway.app
    steps:
      - uses: actions/checkout@v4
      - run: echo TODO
  proxypartylab-prod-gcp:
    name: Dedicated Caddy server on GCP Compute Engine
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://proxyparty.recaptime.dev
    steps:
      - uses: actions/checkout@v4
      - name: Load secrets via dotenvx
        id: dotenvx
        uses: andreijiroh-dev/dotenvx-action@main
        with:
          key: ${{ secrets.DOTENV_PRIVATE_KEY_CI }}
          path: .env.ci
      - name: Setup Tailscale authenication
        run: |
          curl -fsSL https://tailscale.com/install.sh | bash -
          sudo tailscale up --auth-key="${TAILSCALE_OAUTH_CLIENT_SECRET}?ephemeral=true&preauthorized=true" --advertise-tags=tag:github-actions,tag:ci-builds,tag:dev
        env:
          TAILSCALE_OAUTH_CLIENT_SECRET: ${{ steps.dotenvx.outputs.TAILSCALE_OAUTH_CLIENT_SECRET }}
      - name: Build caddy
        run: |
          wget https://github.com/caddyserver/xcaddy/releases/download/v0.4.2/xcaddy_0.4.2_linux_amd64.tar.gz -O /tmp/caddy.tar.gz
          sudo tar zxf /tmp/caddy.tar.gz -C /usr/local/bin
          sudo chmod +x /usr/local/bin/xcaddy
          xcaddy build \
            --output ./caddy-deploy \
            --with github.com/caddy-dns/cloudflare \
            --with github.com/caddy-dns/vercel \
            --with github.com/caddy-dns/netlify \
            --with github.com/ss098/certmagic-s3
          scp ./caddy-deploy caddy@proxypartylab-prod-gcp.tuna-skate.ts.net:/var/caddy/bin/caddy
      - name: Run update script
        run: |
          ssh -o "StrictHostKeyChecking no" caddy@proxypartylab-prod-gcp.tuna-skate.ts.net git -C /var/caddy/src pull --ff-only
          ssh -o "StrictHostKeyChecking no" caddy@proxypartylab-prod-gcp.tuna-skate.ts.net "/var/caddy/src/update"